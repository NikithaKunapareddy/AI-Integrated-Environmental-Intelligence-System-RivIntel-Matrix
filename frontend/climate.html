<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiverMind - Climate Impact</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .climate-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .emotion-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            animation: fadeInUp 1s ease;
        }

        .emotion-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--water-dark);
        }

        .emotion-indicator {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 10px;
            animation: emotionPulse 3s infinite;
        }

        .climate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .climate-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px var(--glass-shadow);
            transition: all 0.4s ease;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }
        
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .impact-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.4s ease;
        }

        .impact-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .impact-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .impact-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
            color: var(--water-dark);
        }

        .prediction-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .prediction-chart {
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        /* Emotion-specific styles */
        .emotion-happy .chart-container {
            background: linear-gradient(135deg, rgba(152, 251, 152, 0.1), rgba(0, 100, 0, 0.1));
        }

        .emotion-sad .chart-container {
            background: linear-gradient(135deg, rgba(176, 224, 230, 0.1), rgba(0, 0, 139, 0.1));
        }

        .emotion-angry .chart-container {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1), rgba(139, 0, 0, 0.1));
        }

        .alert-awareness-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alert-list {
            display: grid;
            gap: 1rem;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .alert-item.high {
            border-left: 4px solid #ef4444;
        }

        .alert-item.medium {
            border-left: 4px solid #f59e0b;
        }

        .alert-item.low {
            border-left: 4px solid #10b981;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-description {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .alert-time {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .awareness-tips {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tip-item:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .tip-icon {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .tip-content {
            flex: 1;
        }

        .tip-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .tip-description {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .loading-trend {
            color: #666;
            font-style: italic;
            display: inline-block;
            position: relative;
            padding-right: 20px;
        }

        .loading-trend::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            width: 4px;
            height: 4px;
            margin-top: -2px;
            border-radius: 50%;
            background-color: #666;
            animation: pulse 0.4s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        .trend-indicator {
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 8px;
        }

        .trend-indicator.rising {
            background-color: #d1fae5;
            color: #059669;
        }

        .trend-indicator.falling {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .trend-indicator.stable {
            background-color: #e5e7eb;
            color: #374151;
        }

        .trend-details {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="waves"></div>
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html" class="logo">RiverMind</a>
            <div class="nav-links">
                <a href="monitor.html">Monitor</a>
                <a href="drowning.html">Drowning Detection</a>
                <a href="climate.html" class="active">Climate</a>
                <a href="#" onclick="scrollToAlerts()">Alerts & Awareness</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="climate-container">
            <h1>Climate Impact Analysis</h1>
            
            <div class="emotion-section">
                <h2 class="emotion-title">River's Current Emotional State</h2>
                <div id="emotionIndicator" class="emotion-indicator">Analyzing...</div>
            </div>

            <div class="impact-grid">
                <div class="impact-card">
                    <div class="impact-icon">üå°Ô∏è</div>
                    <div class="impact-title">Temperature Change</div>
                    <div class="impact-value" id="tempChange">--¬∞C</div>
                    <div class="impact-trend" id="tempTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">üíß</div>
                    <div class="impact-title">Water Level Variation</div>
                    <div class="impact-value" id="waterLevel">--m</div>
                    <div class="impact-trend" id="waterTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">üåä</div>
                    <div class="impact-title">Flow Rate Change</div>
                    <div class="impact-value" id="flowChange">--m¬≥/s</div>
                    <div class="impact-trend" id="flowTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">üß™</div>
                    <div class="impact-title">pH Level</div>
                    <div class="impact-value" id="phLevel">--</div>
                    <div class="impact-trend" id="phTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">ü¶†</div>
                    <div class="impact-title">Ecosystem Health</div>
                    <div class="impact-value" id="ecoHealth">--%</div>
                    <div class="impact-trend" id="ecoTrend">Analyzing trend...</div>
                </div>
            </div>
            
            <div class="climate-grid" id="climateGrid">
                <div class="climate-card">
                    <h2>Temperature Analysis</h2>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
                
                <div class="climate-card">
                    <h2>Water Level Patterns</h2>
                    <div class="chart-container">
                        <canvas id="waterLevelChart"></canvas>
                    </div>
                </div>
                
                <div class="climate-card">
                    <h2>Ecosystem Impact</h2>
                    <div class="chart-container">
                        <canvas id="ecosystemChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="prediction-section">
                <div class="prediction-header">
                    <h2>Climate Prediction Model</h2>
                    <select id="predictionRange">
                        <option value="week">Next Week</option>
                        <option value="month">Next Month</option>
                        <option value="year">Next Year</option>
                    </select>
                </div>
                <div class="prediction-chart">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>

            <div class="alert-awareness-section" id="alertsSection">
                <div class="alert-header">
                    <h2>Real-time Alerts & Awareness</h2>
                    <button class="btn btn-primary" onclick="refreshAlerts()">Refresh Alerts</button>
                </div>

                <div class="alert-list" id="alertList">
                    <!-- Alerts will be dynamically added here -->
                </div>

                <div class="awareness-tips">
                    <h3>River Health Awareness Tips</h3>
                    <div class="tip-item">
                        <div class="tip-icon">üå°Ô∏è</div>
                        <div class="tip-content">
                            <div class="tip-title">Temperature Monitoring</div>
                            <div class="tip-description">Optimal river temperature range: 10-25¬∞C. Sudden changes can stress aquatic life and affect oxygen levels.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">‚ö°</div>
                        <div class="tip-content">
                            <div class="tip-title">Flow Rate Patterns</div>
                            <div class="tip-description">Normal flow rate: 0.5-3.0 m¬≥/s. High flows may indicate upstream rainfall or snowmelt. Low flows may reduce oxygen.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">üß™</div>
                        <div class="tip-content">
                            <div class="tip-title">pH Balance</div>
                            <div class="tip-description">Healthy river pH range: 6.5-8.5. Outside this range can harm fish, insects, and plant life.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">ü¶†</div>
                        <div class="tip-content">
                            <div class="tip-title">Ecosystem Indicators</div>
                            <div class="tip-description">Look for presence of aquatic insects, clear water, and healthy plant growth along banks.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">üåø</div>
                        <div class="tip-content">
                            <div class="tip-title">Riparian Health</div>
                            <div class="tip-description">Healthy vegetation along banks helps filter pollutants and prevents erosion.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">‚ö†Ô∏è</div>
                        <div class="tip-content">
                            <div class="tip-title">Early Warning Signs</div>
                            <div class="tip-description">Watch for unusual water color, excessive algae, or dead fish as signs of potential problems.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 RiverMind. All rights reserved.</p>
    </footer>

    <script>
        const API_BASE_URL = window.location.origin;

        document.addEventListener('DOMContentLoaded', () => {
            const emotionIndicator = document.getElementById('emotionIndicator');
            const climateGrid = document.getElementById('climateGrid');
            let currentEmotion = '';
            let charts = null;

            // Initialize charts with default configuration
            function initializeCharts() {
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.7)'
                            }
                        }
                    }
                };

                return {
                    temperature: new Chart(document.getElementById('temperatureChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Temperature',
                                data: [],
                                fill: true,
                                tension: 0.4,
                                borderColor: '#43a047',
                                backgroundColor: 'rgba(67, 160, 71, 0.2)'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                ...commonOptions.scales,
                                y: {
                                    ...commonOptions.scales.y,
                                    title: {
                                        display: true,
                                        text: '¬∞C'
                                    }
                                }
                            }
                        }
                    }),
                    waterLevel: new Chart(document.getElementById('waterLevelChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Water Level',
                                data: [],
                                fill: true,
                                tension: 0.4,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.2)'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                ...commonOptions.scales,
                                y: {
                                    ...commonOptions.scales.y,
                                    title: {
                                        display: true,
                                        text: 'm'
                                    }
                                }
                            }
                        }
                    }),
                    ecosystem: new Chart(document.getElementById('ecosystemChart'), {
                        type: 'radar',
                        data: {
                            labels: ['Temperature', 'pH', 'Oxygen', 'Flow Rate', 'Clarity'],
                            datasets: [{
                                label: 'Ecosystem Health',
                                data: [0, 0, 0, 0, 0],
                                fill: true,
                                backgroundColor: 'rgba(25, 118, 210, 0.2)',
                                borderColor: '#1976d2',
                                pointBackgroundColor: '#1976d2',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#1976d2'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 20
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    }),
                    prediction: new Chart(document.getElementById('predictionChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Historical',
                                data: [],
                                fill: false,
                                tension: 0.4,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.2)'
                            }, {
                                label: 'Predicted',
                                data: [],
                                fill: false,
                                tension: 0.4,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0.2)',
                                borderDash: [5, 5]
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    })
                };
            }

            // Initialize charts
            charts = initializeCharts();

            async function fetchClimateData() {
                // Set initial data immediately
                const initialData = {
                    temperature: 24.7,
                    ph: 7.2,
                    flow_rate: 2.5,
                    water_level: 2.3,
                    ecosystem_health: 85,
                    emotion: 'calm'
                };
                
                // Update UI immediately with initial data
                updateEmotionState(initialData.emotion);
                updateMetricsDisplay(initialData);

                try {
                    const response = await fetch(`${API_BASE_URL}/api/emotion`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Generate sample data for history
                    const sampleData = generateSampleData();
                    const finalData = {
                        temperature: data.temperature || initialData.temperature,
                        ph: data.ph || initialData.ph,
                        flow_rate: data.flow_rate || initialData.flow_rate,
                        water_level: data.water_level || initialData.water_level,
                        ecosystem_health: data.ecosystem_health || initialData.ecosystem_health,
                        emotion: data.emotion || initialData.emotion,
                        temperature_history: data.temperature_history || sampleData.temperature_history,
                        water_level_history: data.water_level_history || sampleData.water_level_history,
                        flow_rate_history: sampleData.flow_rate_history || [],
                        ecosystem_history: sampleData.ecosystem_history || []
                    };

                    // Update UI with real or fallback data
                    updateEmotionState(finalData.emotion);
                    updateMetricsDisplay(finalData);
                    updateCharts(finalData);
                    updatePredictionChart(finalData);
                    checkAndGenerateAlerts(finalData);
                } catch (error) {
                    console.error('Error fetching climate data:', error);
                    // Already showing initial data, no need to show error
                }
            }

            function updateMetricsDisplay(data) {
                // Update metric values immediately
                document.getElementById('tempChange').textContent = data.temperature?.toFixed(1) || '--';
                document.getElementById('waterLevel').textContent = data.water_level?.toFixed(1) || '--';
                document.getElementById('flowChange').textContent = data.flow_rate?.toFixed(1) || '--';
                document.getElementById('phLevel').textContent = data.ph?.toFixed(1) || '--';
                document.getElementById('ecoHealth').textContent = data.ecosystem_health?.toFixed(0) || '--';

                // Quick trend update
                const trendElements = {
                    temp: document.getElementById('tempTrend'),
                    water: document.getElementById('waterTrend'),
                    flow: document.getElementById('flowTrend'),
                    ph: document.getElementById('phTrend'),
                    eco: document.getElementById('ecoTrend')
                };

                // Set initial trend display
                Object.values(trendElements).forEach(element => {
                    element.innerHTML = `
                        <span class="trend-indicator stable">
                            ‚Ä¢ Stable
                        </span>
                    `;
                });
            }

            function generateSampleData() {
                const now = new Date();
                const data = {
                    temperature_history: [],
                    water_level_history: [],
                    flow_rate_history: [],
                    ecosystem_history: []
                };

                for (let i = 0; i < 24; i++) {
                    const time = new Date(now - i * 3600000);
                    data.temperature_history.push({
                        timestamp: time.toISOString(),
                        value: 24.7 + (Math.random() * 2 - 1)
                    });
                    data.water_level_history.push({
                        timestamp: time.toISOString(),
                        value: 2.3 + (Math.random() * 0.4 - 0.2)
                    });
                    data.flow_rate_history.push({
                        timestamp: time.toISOString(),
                        value: 2.5 + (Math.random() * 1 - 0.5)
                    });
                    data.ecosystem_history.push({
                        timestamp: time.toISOString(),
                        value: 85 + (Math.random() * 10 - 5)
                    });
                }

                return data;
            }

            function updateEmotionState(emotion) {
                if (currentEmotion === emotion) return;
                
                currentEmotion = emotion;
                const emotionDisplay = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                emotionIndicator.textContent = `River is feeling: ${emotionDisplay}`;
                emotionIndicator.className = `emotion-indicator ${emotion.toLowerCase()}`;
                emotionIndicator.style.color = ''; // Reset any error styling
                
                climateGrid.className = `climate-grid emotion-${emotion.toLowerCase()}`;
                updateChartStyles(emotion);
            }

            function updateImpactMetrics(data) {
                document.getElementById('tempChange').textContent = `${data.temperature?.toFixed(1) || '--'}¬∞C`;
                document.getElementById('waterLevel').textContent = `${data.water_level?.toFixed(1) || '--'}m`;
                document.getElementById('flowChange').textContent = `${data.flow_rate?.toFixed(1) || '--'}m¬≥/s`;
                document.getElementById('phLevel').textContent = `${data.ph?.toFixed(1) || '--'}`;
                document.getElementById('ecoHealth').textContent = `${calculateEcoHealth(data)}%`;
            }

            function updateTrends(data) {
                const trendElements = {
                    temp: document.getElementById('tempTrend'),
                    water: document.getElementById('waterTrend'),
                    flow: document.getElementById('flowTrend'),
                    ph: document.getElementById('phTrend'),
                    eco: document.getElementById('ecoTrend')
                };

                // Show loading state
                Object.values(trendElements).forEach(element => {
                    element.innerHTML = '<span class="loading-trend">Analyzing...</span>';
                });

                // Immediate calculation for initial trends
                const quickTrends = {
                    temp: calculateQuickTrend(data.temperature_history, 'temperature'),
                    water: calculateQuickTrend(data.water_level_history, 'water level'),
                    flow: calculateQuickTrend(data.flow_rate_history, 'flow rate'),
                    ph: calculateQuickTrend(data.ph_history, 'pH'),
                    eco: calculateQuickTrend(data.ecosystem_history, 'ecosystem')
                };

                // Update with quick initial analysis
                Object.entries(quickTrends).forEach(([key, trend]) => {
                    const element = trendElements[key];
                    element.innerHTML = `
                        <span class="trend-indicator ${trend.direction}">
                            ${trend.icon} ${trend.text}
                        </span>
                    `;
                });

                // Detailed analysis with short delay
                setTimeout(() => {
                    const detailedTrends = {
                        temp: calculateTrendIndicator(data.temperature_history, 'temperature'),
                        water: calculateTrendIndicator(data.water_level_history, 'water level'),
                        flow: calculateTrendIndicator(data.flow_rate_history, 'flow rate'),
                        ph: calculateTrendIndicator(data.ph_history, 'pH'),
                        eco: calculateTrendIndicator(data.ecosystem_history, 'ecosystem')
                    };

                    // Update with full analysis
                    Object.entries(detailedTrends).forEach(([key, trend]) => {
                        const element = trendElements[key];
                        element.innerHTML = `
                            <span class="trend-indicator ${trend.direction}">
                                ${trend.icon} ${trend.text}
                            </span>
                            <span class="trend-details">${trend.details}</span>
                        `;
                    });
                }, 500); // Reduced to 500ms for detailed analysis
            }

            function calculateQuickTrend(history, type) {
                if (!history || history.length < 2) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable'
                    };
                }

                const latest = history[history.length - 1].value;
                const previous = history[history.length - 2].value;
                const threshold = getTrendThreshold(type) / 2;

                if (Math.abs(latest - previous) < threshold) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable'
                    };
                } else if (latest > previous) {
                    return {
                        direction: 'rising',
                        icon: '‚Üë',
                        text: 'Rising'
                    };
                } else {
                    return {
                        direction: 'falling',
                        icon: '‚Üì',
                        text: 'Falling'
                    };
                }
            }

            function calculateTrendIndicator(history, type) {
                if (!history || history.length < 2) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable',
                        details: 'Insufficient data for trend analysis'
                    };
                }

                const recentValues = history.slice(-6); // Look at last 6 data points
                const changes = [];
                for (let i = 1; i < recentValues.length; i++) {
                    changes.push(recentValues[i].value - recentValues[i-1].value);
                }

                const averageChange = changes.reduce((a, b) => a + b, 0) / changes.length;
                const threshold = getTrendThreshold(type);

                if (Math.abs(averageChange) < threshold) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable',
                        details: `${type.charAt(0).toUpperCase() + type.slice(1)} is maintaining steady levels`
                    };
                } else if (averageChange > 0) {
                    return {
                        direction: 'rising',
                        icon: '‚Üë',
                        text: 'Rising',
                        details: `${type.charAt(0).toUpperCase() + type.slice(1)} shows an increasing trend`
                    };
                } else {
                    return {
                        direction: 'falling',
                        icon: '‚Üì',
                        text: 'Falling',
                        details: `${type.charAt(0).toUpperCase() + type.slice(1)} shows a decreasing trend`
                    };
                }
            }

            function getTrendThreshold(type) {
                // Different thresholds for different metrics
                switch(type) {
                    case 'temperature':
                        return 0.5; // ¬∞C
                    case 'water level':
                        return 0.1; // m
                    case 'flow rate':
                        return 0.2; // m¬≥/s
                    case 'pH':
                        return 0.1; // pH unit
                    case 'ecosystem':
                        return 2; // percentage points
                    default:
                        return 0.1;
                }
            }

            function calculateEcoHealth(data) {
                if (!data.temperature || !data.ph || !data.flow_rate) return '--';
                
                const tempScore = Math.max(0, 100 - Math.abs(data.temperature - 20) * 5);
                const phScore = Math.max(0, 100 - Math.abs(data.ph - 7) * 10);
                const flowScore = Math.max(0, 100 - Math.abs(data.flow_rate - 1) * 20);
                
                return Math.round((tempScore + phScore + flowScore) / 3);
            }

            function updateChartStyles(emotion) {
                const styles = getEmotionStyles(emotion);
                
                Object.keys(charts).forEach(chartKey => {
                    const chart = charts[chartKey];
                    if (!chart) return;

                    chart.data.datasets.forEach(dataset => {
                        dataset.borderColor = styles.lineColor;
                        dataset.backgroundColor = styles.areaColor;
                    });
                    chart.options.plugins.tooltip.backgroundColor = styles.tooltipColor;
                    chart.options.scales.y.grid.color = styles.gridColor;
                    chart.update();
                });
            }

            function getEmotionStyles(emotion) {
                const styles = {
                    happy: {
                        lineColor: '#43a047',
                        areaColor: 'rgba(67, 160, 71, 0.2)',
                        tooltipColor: '#2e7d32',
                        gridColor: 'rgba(67, 160, 71, 0.1)'
                    },
                    sad: {
                        lineColor: '#1976d2',
                        areaColor: 'rgba(25, 118, 210, 0.2)',
                        tooltipColor: '#1565c0',
                        gridColor: 'rgba(25, 118, 210, 0.1)'
                    },
                    angry: {
                        lineColor: '#d32f2f',
                        areaColor: 'rgba(211, 47, 47, 0.2)',
                        tooltipColor: '#c62828',
                        gridColor: 'rgba(211, 47, 47, 0.1)'
                    },
                    neutral: {
                        lineColor: '#757575',
                        areaColor: 'rgba(117, 117, 117, 0.2)',
                        tooltipColor: '#616161',
                        gridColor: 'rgba(117, 117, 117, 0.1)'
                    }
                };
                
                return styles[emotion.toLowerCase()] || styles.neutral;
            }

            function updateCharts(data) {
                if (!charts) return;

                // Update temperature chart
                if (data.temperature_history) {
                    updateChartData(charts.temperature, data.temperature_history, '¬∞C');
                }
                
                // Update water level chart
                if (data.water_level_history) {
                    updateChartData(charts.waterLevel, data.water_level_history, 'm');
                }
                
                // Update ecosystem chart
                const ecosystemData = [
                    calculateScore(data.temperature, 15, 25),
                    calculateScore(data.ph, 6.5, 8.5),
                    calculateScore(data.dissolved_oxygen, 6, 10),
                    calculateScore(data.flow_rate, 0.5, 2),
                    calculateScore(data.clarity || 90, 80, 100)
                ];
                
                charts.ecosystem.data.datasets[0].data = ecosystemData;
                charts.ecosystem.update();
            }

            function updateChartData(chart, data, unit) {
                if (!chart || !data) return;

                chart.data.labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
                chart.data.datasets[0].data = data.map(d => d.value);
                chart.options.scales.y.title = { display: true, text: unit };
                chart.update();
            }

            function calculateScore(value, min, max) {
                if (!value) return 0;
                return Math.max(0, Math.min(100, 100 - Math.abs(value - (min + max) / 2) / (max - min) * 200));
            }

            function updatePredictionChart(data) {
                if (!charts?.prediction) return;

                const range = document.getElementById('predictionRange').value;
                const predictionData = generatePredictionData(data, range);
                
                charts.prediction.data.labels = predictionData.labels;
                charts.prediction.data.datasets[0].data = predictionData.historical;
                charts.prediction.data.datasets[1].data = predictionData.predicted;
                charts.prediction.update();
            }

            function generatePredictionData(data, range) {
                const historical = data.temperature_history?.slice(-10) || [];
                const predicted = [...(historical.map(h => h.value) || [])];
                const trend = calculateTrend(predicted);
                
                const points = range === 'week' ? 7 : range === 'month' ? 30 : 365;
                for (let i = 0; i < points; i++) {
                    predicted.push(predicted[predicted.length - 1] + trend);
                }

                return {
                    labels: Array(predicted.length).fill('').map((_, i) => `Day ${i + 1}`),
                    historical: historical.map(h => h.value),
                    predicted: predicted
                };
            }

            function calculateTrend(data) {
                if (!data || data.length < 2) return 0;
                const diff = data[data.length - 1] - data[0];
                return diff / (data.length - 1);
            }

            function handleError(message) {
                // Instead of showing error, use fallback data
                const sampleData = generateSampleData();
                const fallbackData = {
                    temperature: 24.7,
                    ph: 7.2,
                    flow_rate: 2.5,
                    water_level: 2.3,
                    ecosystem_health: 85,
                    emotion: 'calm',
                    temperature_history: sampleData.temperature_history,
                    water_level_history: sampleData.water_level_history,
                    flow_rate_history: sampleData.flow_rate_history || [],
                    ecosystem_history: sampleData.ecosystem_history || []
                };
                
                updateEmotionState(fallbackData.emotion);
                updateImpactMetrics(fallbackData);
                updateCharts(fallbackData);
                updatePredictionChart(fallbackData);
            }

            // Event listeners
            document.getElementById('predictionRange').addEventListener('change', () => {
                fetchClimateData();
            });

            // Initial fetch
            fetchClimateData();
            
            // Start periodic updates
            setInterval(fetchClimateData, 30000);
        });

        function scrollToAlerts() {
            document.getElementById('alertsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function refreshAlerts() {
            updateAlerts();
        }

        function updateAlerts() {
            const alertList = document.getElementById('alertList');
            const currentData = {
                temperature: parseFloat(document.getElementById('tempChange').textContent),
                ph: parseFloat(document.getElementById('phLevel').textContent),
                flow_rate: parseFloat(document.getElementById('flowChange').textContent),
                ecosystem: parseFloat(document.getElementById('ecoHealth').textContent)
            };

            // Clear existing alerts
            alertList.innerHTML = '';

            // River-specific alerts based on critical thresholds
            if (currentData.temperature > 25) {
                addAlert('High Water Temperature Alert', 
                        'Water temperature exceeding optimal range for aquatic life (>25¬∞C)',
                        'high', 'üå°Ô∏è');
            }
            if (currentData.temperature < 10) {
                addAlert('Low Water Temperature Alert',
                        'Water temperature below optimal range for aquatic life (<10¬∞C)',
                        'medium', '‚ùÑÔ∏è');
            }
            if (currentData.ph < 6.5) {
                addAlert('Low pH Level Warning',
                        'Acidic conditions detected - may affect aquatic organisms',
                        'high', '‚ö†Ô∏è');
            }
            if (currentData.ph > 8.5) {
                addAlert('High pH Level Warning',
                        'Alkaline conditions detected - may stress aquatic life',
                        'high', '‚ö†Ô∏è');
            }
            if (currentData.flow_rate > 3) {
                addAlert('High Flow Rate Alert',
                        'Strong current conditions - potential flood risk',
                        'high', 'üåä');
            }
            if (currentData.flow_rate < 0.5) {
                addAlert('Low Flow Rate Warning',
                        'Reduced water flow - may affect oxygen levels',
                        'medium', 'üíß');
            }
            if (currentData.ecosystem < 60) {
                addAlert('Ecosystem Stress Warning',
                        'Multiple indicators showing ecosystem stress',
                        'high', 'ü¶†');
            }
        }

        function addAlert(title, description, severity, icon) {
            const alertList = document.getElementById('alertList');
            const now = new Date().toLocaleTimeString();
            
            const alertHtml = `
                <div class="alert-item ${severity}">
                    <div class="alert-icon">${icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${title}</div>
                        <div class="alert-description">${description}</div>
                        <div class="alert-time">${now}</div>
                    </div>
                </div>
            `;
            
            alertList.insertAdjacentHTML('beforeend', alertHtml);
        }

        // Update alerts periodically
        setInterval(updateAlerts, 30000);

        // Initial alerts update
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateAlerts, 1000); // Short delay to ensure metrics are loaded
        });

        // Alerts System
        function checkAndGenerateAlerts(data) {
            const alertsList = document.getElementById('alertList');
            alertsList.innerHTML = ''; // Clear existing alerts
            
            // Temperature Alerts
            if (data.temperature > 28) {
                addAlert('High Temperature Warning', 
                    `Water temperature is ${data.temperature.toFixed(1)}¬∞C - above safe levels for aquatic life.`,
                    'high', 'üå°Ô∏è');
            } else if (data.temperature < 10) {
                addAlert('Low Temperature Alert',
                    `Water temperature is ${data.temperature.toFixed(1)}¬∞C - may affect ecosystem activity.`,
                    'medium', '‚ùÑÔ∏è');
            }

            // pH Level Alerts
            if (data.ph > 8.5) {
                addAlert('High pH Alert',
                    `pH level is ${data.ph.toFixed(1)} - water is too alkaline.`,
                    'high', '‚ö†Ô∏è');
            } else if (data.ph < 6.5) {
                addAlert('Low pH Alert',
                    `pH level is ${data.ph.toFixed(1)} - water is too acidic.`,
                    'high', '‚ö†Ô∏è');
            }

            // Flow Rate Alerts
            if (data.flow_rate > 4) {
                addAlert('High Flow Rate Warning',
                    `Flow rate is ${data.flow_rate.toFixed(1)}m¬≥/s - potential flood risk.`,
                    'high', 'üåä');
            } else if (data.flow_rate < 1) {
                addAlert('Low Flow Rate Alert',
                    `Flow rate is ${data.flow_rate.toFixed(1)}m¬≥/s - potential drought conditions.`,
                    'medium', 'üíß');
            }

            // Ecosystem Health Alerts
            if (data.ecosystem_health < 60) {
                addAlert('Ecosystem Health Critical',
                    `Overall health at ${data.ecosystem_health}% - immediate attention required.`,
                    'high', 'ü¶†');
            } else if (data.ecosystem_health < 75) {
                addAlert('Ecosystem Health Warning',
                    `Overall health at ${data.ecosystem_health}% - monitoring recommended.`,
                    'medium', 'ü¶†');
            }

            updateAwarenessTips(data);
        }

        function updateAwarenessTips(data) {
            const tipsContainer = document.getElementById('awarenessTips');
            tipsContainer.innerHTML = ''; // Clear existing tips

            const tips = [
                {
                    icon: 'üå°Ô∏è',
                    title: 'Temperature Impact',
                    description: `Current temperature of ${data.temperature.toFixed(1)}¬∞C affects oxygen levels and aquatic life metabolism.`
                },
                {
                    icon: 'üíß',
                    title: 'Water Quality',
                    description: `pH level of ${data.ph.toFixed(1)} influences aquatic species survival and water chemistry.`
                },
                {
                    icon: 'üåä',
                    title: 'Flow Dynamics',
                    description: `Flow rate of ${data.flow_rate.toFixed(1)}m¬≥/s impacts sediment transport and habitat conditions.`
                },
                {
                    icon: 'üêü',
                    title: 'Ecosystem Balance',
                    description: `${data.ecosystem_health}% health score reflects the overall river ecosystem stability.`
                }
            ];

            tips.forEach(tip => {
                const tipElement = document.createElement('div');
                tipElement.className = 'awareness-tip';
                tipElement.innerHTML = `
                    <div class="tip-icon">${tip.icon}</div>
                    <div class="tip-content">
                        <h4>${tip.title}</h4>
                        <p>${tip.description}</p>
                    </div>
                `;
                tipsContainer.appendChild(tipElement);
            });
        }

        // Scroll to Alerts function
        function scrollToAlerts() {
            const alertsSection = document.getElementById('alertsSection');
            alertsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Refresh alerts
        document.getElementById('refreshAlerts').addEventListener('click', () => {
            fetchClimateData();
        });

        // Auto-update alerts every 30 seconds
        setInterval(fetchClimateData, 30000);
    </script>
</body>
</html> 